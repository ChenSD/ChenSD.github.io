---
layout: post
title:   ERP处理笔记
date:   2019-07-11 22:10:20
categories: toolbox
---

# ERP实验设计编程和数据采集

ERP实验设计和数据采集与行为实验存在较大的差别，具有一些特别的要求，如实验刺激的试次和类型。如果这两个步骤出现问题，则后期的数据处理就失去了大楼的基石。

## Experimental Design

Ask yourself the following questions.

1. Which cognitive processes do you want to study? Is it ERP necessary?

2. Which ERP components you want to use to represent the cognitive processes of interest?

3. Is your design in line with the ERP princinples (see Luck book for more detail)?

4. How many trials? How many participants?

## Data collection

1. 准备哪些材料？ 脑电膏，棉棒，胶布，去角质膏，脑电帽和配套识别文件
2. 脑电实验特别注意事项：头动，眼睛和屏幕间距，刺激呈现在屏幕中的位置和大小，房间电器的控制
3. 打电极膏注意事项
4. 数据采集过程中实时观察数据质量并记录

# ERP Components in the field of emotion regulation

1. 每个成分需要注意的事项：
   0. 基线的标准（-200ms）。
   1. 其参考点有没有特别要求，平均参考还是双侧乳突？
   2. 其空间分布的经典位置在哪些电极点上？
   3. 其时间分布的经典时间窗是哪些时间段？
   4. 其时间分段的通用标准是什么？
   5. 其常用的指标又哪些，振幅还是潜伏期？每个指标的心理学含义是什么？
   6. 其操作化定义，具体计算的方法是什么？

2. 建议：不要仅仅靠语句计算出ERP指标然后就去做统计。再这之前，肉眼观察每个测量到的
ERP成分。画出每个被试的波形图，观察比较其成分的波幅和潜伏期。这是因为被试间的波形
往往差异很大。   
   
## Early components (<300ms)

1. C1, P100, P200, N100, N170（面孔特异性）, N200, 

2. Early Posterior Negativity (EPN), highly responsive to phylogenetically threatening stimuli

3. MisMatched Negativity (MMN)

4. Error-related negativity (ERN) typically peaks from 80-150 milliseconds (ms) 
after the erroneous response begins

2. 关注哪一个早期ERP成分取决于实验刺激呈现的感官通道。不同的感官通道，如视觉和听觉，所诱发的
ERP成分（如N1），其到达顶峰的时间可能有所重合，但是头皮分布往往差别很大。
例如，与任务相关的听觉和视觉刺激都会诱发出N2b成分，但听觉刺激的反应在中央区最大，
而视觉刺激的反应在头后部最大。

### 经典指标的计算

0. 确定电极点（electrodes）-根据参考文献和综述。

1. 确定peak点。local peak amplitude method should be used, because it reflect the peak better
than the maximum voltage method (See Luck 2014). 可以使用matlab中的findpeaks函数实现。

``[pks,locs] = findpeaks(data) additionally returns the indices at which the peaks occur.``

2. 平均振幅。选用某些电极点peak前后某段时间窗内的电位平均值。
注意，这一方法不宜选用过窄的时间窗（<40ms）。这是因为虽然
更窄的时间窗能够更好地避免重叠成分的影响，但其受条件间、电极点之间以及不同被试间
变异的影响更大。

3. 潜伏期，即经典成分peak出现的时间。

## Late Components (>300ms) 

0. P300 LPP N400（语言加工成分）
1. LPP： early (300-1000) and late (>1000) LPP
1. 必须以双侧乳突为参考点
2. 建议以图片呈现时间来进行分段，例如图片呈现4s，就以4s来分段。
3. LPP可以分为早期LPP（<1000ms），和晚期LPP
4. 计算方法：建议从300ms开始，以200ms为最小时间单位分段。

# ERP-EEG Data Preprocessing


## 第一步，预处理流程

1. Prepare data1. 检查被试的命名是否统一（e.g., sub01_name.*）,
检查所有被试的marker命名是否正确。
2. Prepare data2. 如果存在不一致的问题，例如由于编程时问题，marker名称不统一或重复，
使用语句对marker进行重命名。确保数据中，实验条件与marker一一对应，没有错误。
3. 确定预处理参数。例如离线参考点？
4. 第一次预处理，生成基于1HZ高通滤波数据的ICA矩阵信息；
5. 第二次预处理，应用上一次生成的ICA矩阵信息，并对数据进行分段，剔除坏段。
6. 利用EEGLAB Adjust插件半自动化地去除眼电的ICA成分。
7. 最后，平均试次维度，计算出所有被试，所有条件，所有时间点，所有通道的平均值。
最后的数据是一个四维数据。Size pf EEG_avg: subj*cond*channel*time。

## 第二步，检查数据，保证质量

有些被试由于头动等莫名其妙的原因，其电位可能比正常被试的数据大几十倍。In this case,
这一个极端被试的混入就能左右结果的显著性。为了避免这种极端值，需要对数据进行质量控制，
剔除极端被试，避免污染结果。

1. 对每个被试的感兴趣成分进行绘图，观察电位强度范围，以及ERP波的走向。
例如LPP的波幅强度（就情绪唤起而言），一般在10-15左右。如果一个被试的电位到了100，
这个被试很可能就会影响结果的显著性。而且这种被试的原始数据一般也会有问题，怎么剔除坏段
都救不回来。Rubbish in, rubbish out.
2. 求出所有被试某个成分的值，直接观察原始值。然后重点对极端值绘图。

## 第三步，统计分析

1. 计算ERPs指标。此分析基于预处理后汇总的四维数据，四个维度分别为subj*cond*channel*time。以计算每个被试在每个条件下的LPP波幅为例，此处需要根据选择的通道和时间段平均掉通道和时间维度，即可得到所要结果。此结果从matlab中copy到SPSS或R中进行后续的统计或画图步骤。
2. 计算TFA指标。与ERP不同，TFA数据分析还需要在预处理后再进行时频变换，最后得到汇总的一个五维数据。与ERP汇总数据相比，多了一个频率维度。五个维度分别为：被试*条件*channel*time*frequency。

## 第四步，绘图

了解常见的图形类型，含义以及绘图要求：
    1. 地形图
	2. 波形图
	3. 能量示意图（X时间，Y频率，能量为填充）

# 时频分析(Time-Frequency Analysis, TFA)

## Basic terms

0. 常见术语：
    Time-Frequency Analysis, TFA 
	Event-related spectral perturbations, ERSP
1. In signal processing, Time–Frequency Analysis (TFA) comprises those techniques 
that study a signal in both the Time and Frequency Domains (TFD) simultaneously. 
2. 脑电波中α频段（8~12Hz）和β频段（13~30Hz）的振荡(降低和增强)可以显示出事件相关的中止反应或事件相关的增强, 其中前者被称为事件相关同步化(event-related synchronization, ERS), 
后者称之为事件相关去同步化(event-related desynchronization, ERD). 
3. ERS和ERD具有以下特性(参考自刘刚&孙伟, 2011):
    1. 频段特异性: alpha和beta频段的ERD可作为大脑激活的指标，
	而ERS的出现则表明大脑处于失活状态，提示皮质区域恢复到静息或惰性状态(Pineda 2005) 。
	与之相反，gamma频段的ERS 与皮质激活相关，可能参与多区域和多种模式的信息整合加工过程(Cheyne, et al., 2008) 。 不同频段在正常和病理的运动加工过程中表现出不同的振荡模式，表明在大脑皮质和皮质下水平可能有着相互作用的独立功能调节机制来参与运动神经环路的信息加工。
	2. 锁时性: 前人EEG和MEG的研究发现感觉运动皮层的神经反应振荡活动在运动开始前几百毫秒出现并持续到运动结束后几秒钟。
	例如，在运动开始前几百毫秒，alpha和beta频段的能量会迅速降低（ERD），在运动结束之后１ ～２ ｓ beta频段能量会迅速增高（ERS）(Pineda 2005)
4. 情绪相关研究中, ERS和ERD往往用于确定感兴趣的时间-频率窗(TFD of interest)
5. 常见因变量指标：
     1. 能量（power）. 确定好感兴趣的TFD之后, 就需要从感兴趣的TFD中提取每个实验条件的节律能量. 
     2. 相位一致性(Phase Locking Index, PLI)
	 3. 耦合(Coherence). 不同电极同频率信号的相位同步性(Phase Synchrony)

## General Steps

1. 总体步骤: eeglab里面前面的preprocessing是一样的，只是后面处理的时候选TFA或者ERP
2. 函数. 利用每个被试的预处理和ICA去眼动后的文件，可以进行时间-频率分析。EEGLAB主要采用自带的newtimef()函数进行时频分析. 
newtimef()函数中进行TFA分析的核心函数有如下选择:
    * 第一, 采用短时傅立叶(short-time Fourier transform,STFT)变换，可以对感兴趣的较低的频率进行分析。STFT有诸多优点, 但是也有两大缺点:
	    1. First, it treats the power within the window as if it was the power at the center of the window, even though the entire window contributes equally to the power measurement.
		2. STFT依赖于一个固定的时间窗. 而时间窗的长短直接影响时间分辨率和频率分辨率. 窄窗口时间分辨率高但频率分辨率低, 宽窗口时间分辨率低但频率分辨率高. 对于时变的非稳态信号(EEG信号就是典型), 高频适合用小窗口, 低频适合用大窗口.
		然而STFT的时间窗是固定的,在一次TFA分析中是不会变化的. 因此, STFT无法满足非稳态信号变化频率的要求.
	* 第二, 采用小波变换,这里主要使用的是Morlet wavelets。由于小波变换没有像傅立叶变换使用无限长的三角函数, 而是换成了会衰减的小波基. 小波基不仅能够获取频率, 还能定位时间.
	用高斯函数(Gaussian function, bell curve) function)乘以正弦波就成了Morlet小波。
	![](/images/2019-12-27_ERP1.jpg)
3. 画图. TFA分析主要涉及两个图:
    * 第一个是总平均时间-频率图. 该图是指根据newtimef()进行参数设置后，计算每个被试每种条件下的时频图，然后进行平均得出的。基于总平均时间-频率图, 可以通过肉眼得到感兴趣的TFD.
	* 第二个是感兴趣的频率的时间能量波形图。该图是根据自己感兴趣的TFD，只计算和分析自己感兴趣的频带的能量分布图。
4. 数据. 要画出上述两个图，首先必须建立总平均时间频率文件, 即被试*条件*channel*time*frequency的数据. 这个文件是进行后续数据处理的基础. 基于这一数据, 后续分析如下:
    * 第一, 平均掉总数据集中的被试,通道和条件维度, 获得time*frequency的二维数据. 基于这一二维数据, 即可绘制总平均时间-频率图.
	* 第二, 根据总平均时间-频率图得到感兴趣的TFD之后, 即确定了所需要分析的具体波段和具体时间窗口. 
	* 第三, 根据所确定的TFD(已确定的时间和频率), 从总数据集合中提取出每个被试在每个条件下该TFD的ERSP的值，然后根据该数据进行进一步的统计分析(如ANOVA)。
5. 基线矫正(Baseline Correction). 主要基线矫正方法有如下三种:
    * some studies subtract the average baseline power at a given frequency from the power at each poststimulus time point for that frequency. 
	* Other studies use division rather than subtraction (i.e., for each frequency, the power at each poststimulus time point is divided by the average prestimulus power). 
	* In other studies, the change between the prestimulus baseline and the poststimulus period is represented 
	on a log scale (decibels) to take into account the fact that power typically falls off as the frequency increases.

## 具体流程

有三种选择:
1. 使用EEGLAB自带的功能进行时频分析. 但是EEGLAB的组分析study功能特别难用. 优点是只要study建好了, 后续也可以直接点点点.
2. [letswave教程：脑电数据的时频分析/组平均与统计分析](https://mp.weixin.qq.com/s?__biz=MzI0MTQxNDE5NA==&mid=2247486652&idx=1&sn=8eb5ea69daae3f7d7642312e20edf53a&chksm=e90ab5e1de7d3cf7691ddb8274de58d4d2171c98494fb942a3762cc6492e32d26fd33f5613a4&mpshare=1&scene=1&srcid=1227zlBZaMesgcvkMjWUYxyB&sharer_sharetime=1577414424843&sharer_shareid=4905f7abc86408fc345b135a8501550f&key=288743bececaa03f8f0e198e3d692dcf58b796503fc225ede3c6500ded0fc7aa67f118fade53f6270ec123578516d5b74fe810ef1ad3f20e7ccfd930908d7beeeeed7fcee55c1ae0e25dc8dcab4d818b&ascene=1&uin=MTcxODg3OTg2NA%3D%3D&devicetype=Windows+10&version=62070158&lang=zh_CN&exportkey=AZD6CxAiOt%2BiN1ZvdX1vcyc%3D&pass_ticket=Z8hRh0Kh90VixkwSwMz%2BqrY7kBDwhm%2BIOsk1Debq0tEGSxp2si0u7siscgypmtx0)	
	letswave的优点在于不用编写代码, GUI全程点点点就可以得到结果.
3. 直接上代码, 对原始数据进行处理. 代码分析的关键是选择什么样的函数进行时频变换，常见的有小波变换，短时傅立叶变换（STFT）。
	
# References

1. Uusberg, A., Thiruchselvam, R., & Gross, J. J. (2014). Using distraction to regulate emotion: Insights from EEG theta dynamics. International Journal of Psychophysiology, 91(3), 254-260.
2. https://www.cnblogs.com/minks/p/5946442.html
3. 知乎: 如何通俗地讲解傅立叶分析和小波分析间的关系?
4. 武侠, 钟楚鹏, 丁玉珑, & 曲折. (2018). 利用时频分析研究非相位锁定脑电活动. 心理科学进展, v.26；No.216(08), 23-38.